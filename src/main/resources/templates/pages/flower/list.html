<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:include="/common/common :: head('花卉列表')"></head>
<body>

<div class="weadmin-body">
    <div id="search" style="padding-top:30px;padding-right: 70px;">
        <form id="searchForm"class="layui-form" action="">
            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label">花名</label>
                    <div class="layui-input-inline">
                        <input type="text" name="name"  autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">拉丁名</label>
                    <div class="layui-input-inline">
                        <input type="text" name="latinname" autocomplete="off" class="layui-input">
                    </div>
                </div>
            </div>
            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label">门</label>
                    <div class="layui-input-inline">
                        <input type="text" name="phylumname" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">纲</label>
                    <div class="layui-input-inline">
                        <input type="text" name="classname" autocomplete="off" class="layui-input" >
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">目</label>
                    <div class="layui-input-inline">
                        <input type="text" name="ordername"  utocomplete="off" class="layui-input" >
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">科</label>
                    <div class="layui-input-inline">
                        <input type="text" name="familyname" autocomplete="off" class="layui-input" >
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">属</label>
                    <div class="layui-input-inline">
                        <input type="text" name="genusname"   autocomplete="off" class="layui-input" >
                    </div>
                </div>
                <div class="layui-form-item">
                    <div class="layui-input-block">
                        <button class="layui-btn" lay-submit lay-filter="searchaction">搜索</button>
                    </div>
                </div>
            </div>

        </form>
    </div>

    <table id="flowerData"  lay-filter="manage">
    </table>

    <div id="add" style="padding-top:30px;padding-right: 70px;display: none">
        <form id="aform"class="layui-form" action="">
            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label">花名</label>
                    <div class="layui-input-inline">
                        <input type="text" name="name" required  lay-verify="required" placeholder="请输入花名" autocomplete="off" class="layui-input" style="width: 300px;">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">拉丁名</label>
                    <div class="layui-input-inline">
                        <input type="text" name="latinname" required  lay-verify="required" placeholder="请输入花名" autocomplete="off" class="layui-input" style="width: 300px;">
                    </div>
                </div>
            </div>
            <div class="layui-form-item layui-form-text">
                <label class="layui-form-label">描述</label>
                <div class="layui-input-block">
                    <textarea name="description" placeholder="请输入内容" class="layui-textarea"></textarea>
                </div>
            </div>
            <fieldset class="layui-elem-field layui-field-title" style="margin-top: 30px;">
                <legend>以下若无法匹配请到管理页面编辑</legend>
            </fieldset>
            <div class="layui-form-item">
                <label class="layui-form-label">门</label>
                <div class="layui-input-block" style="width: 200px;">
                    <select id="phylumname" name="phylumname" lay-filter="phylumname">
                        <option value="">请选择一项</option>
                    </select>
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">纲</label>
                <div class="layui-input-block" style="width: 200px;">
                    <select id="classname" name="classname" lay-filter="classname">
                        <option value="">请选择一项</option>
                    </select>
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">目</label>
                <div class="layui-input-inline" style="width: 200px;">
                    <select id="ordername" name="ordername" lay-filter="ordername">
                        <option value="">请选择一项</option>
                    </select>
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">科</label>
                <div class="layui-input-inline" style="width: 200px;">
                    <select id="familyname" name="familyname" lay-filter="familyname" >
                        <option value="">请选择一项</option>
                    </select>
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">属</label>
                <div class="layui-input-inline" style="width: 200px;">
                    <select id="genusname" name="genusname" lay-filter="genusname">
                        <option value="">请选择一项</option>
                    </select>
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">种</label>
                <div class="layui-input-inline" style="width: 200px;">
                    <select id="speciesname" name="speciesname" lay-filter="speciesname" >
                        <option value="">请选择一项</option>
                    </select>
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">亚种</label>
                <div class="layui-input-inline" style="width: 200px;">
                    <select id="subspeciesname" name="subspeciesname" lay-filter="subspeciesname" >
                        <option value="">请选择一项</option>
                    </select>
                </div>
            </div>
            <div class="layui-form-item">
                <div class="layui-input-block">
                    <button class="layui-btn" lay-submit lay-filter="insertaction">立即提交</button>
                    <button type="reset" class="layui-btn layui-btn-primary">重置</button>
                </div>
            </div>
        </form>
    </div>
</div>

<script type="text/html" id="bar" th:inline="none">
    <a class="layui-btn layui-btn-xs" lay-event="edit">编辑类别</a>
    <a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="detail">查看图片</a>
</script>
<script th:inline="none">
    var $ = layui.$;
    function getTaxonomy(form, selectValue, select, nextSelect){
        nextSelect.children("option").remove();
        var data = {};
        data[select.attr('id')] = selectValue;
        $.ajax({
            type: 'post',
            contentType: 'application/json',
            url: '/taxonomy/edit',
            data: JSON.stringify(data),
            success: function(data) {
                nextSelect.append("<option value=''>请选择一项</option>");
                for( i = 0; i < data.length; i++ ) {
                    nextSelect.append("<option value='" + data[i].name + "'>" + data[i].name + "</option>");
                }
                form.render();
            }
        });
    };


    layui.use('table', function () {
        var table = layui.table;
        var $ = layui.jquery
        //第一个实例
        table.render({
            elem: '#flowerData'
            , cellMinWidth: 80
            , url: '/flower/list' //数据接口
            , page: true //开启分页
            , toolbar: 'default'
            , cols: [[
                {type: 'checkbox'}
                /*,{field: 'id', title: 'id', sort: true}*/
                , {field: 'name', title: '学名', edit: 'text'}
                , {field: 'latinname', title: '拉丁学名', edit: 'text'}
                , {field: 'description', title: '描述', edit: 'text'}
                , {field: 'phylumname', title: '门', edit: 'text'}
                , {field: 'classname', title: '纲', edit: 'text'}
                , {field: 'ordername', title: '目', edit: 'text'}
                , {field: 'familyname', title: '科', edit: 'text'}
                , {field: 'genusname', title: '属', edit: 'text'}
                , {field: 'speciesname', title: '种', edit: 'text'}
                , {field: 'subspeciesname', title: '亚种', edit: 'text'}
                , {field: 'gmtCreate', title: '创建时间'}
                , {field: 'gmtModified', title: '修改时间'}
                , {fixed: 'right', title: '操作', toolbar: '#bar', width: 150}
            ]]
        });
        // 上方框
        table.on('toolbar(manage)', function (obj) {
            var checkStatus = table.checkStatus(obj.config.id);
            switch (obj.event) {
                case 'add':
                    layer.open({
                        type: 1,
                        title: '添加',
                        shadeClose: true,
                        shade: 0.8,
                        area: ['600px', '80%'],
                        content: $('#add'),
                        cancel: function (index, layero) {
                            table.reload('flowerData', {});
                            layer.close(index)

                            return false;
                        }
                    });
                    break;
                case 'delete':
                    console.log(checkStatus.data);
                    $.ajax({
                        type: 'post',
                        contentType: 'application/json',
                        url: '/flower/delete',
                        data: JSON.stringify(checkStatus.data),
                        success: function (data) {
                            if (data.code == '200') {
                                layer.msg("删除成功");
                                table.reload('flowerData', {});
                                return false;
                            }
                        }
                    });
                    break;
                case 'update':
                    layer.msg('编辑');
                    break;
            }
            ;
        });
        //监听单元格编辑
        table.on('edit(manage)', function (obj) {
            var value = obj.value //得到修改后的值
                , data = obj.data //得到所在行所有键值
                , field = obj.field; //得到字段
            var record = {};
            record.id = data.id
            record[obj.field] = value;
            $.ajax({
                type: 'post',
                contentType: 'application/json',
                url: '/flower/update',
                data: JSON.stringify(record),
                success: function (data) {
                    if (data == 'success') {
                        layer.msg('[ID: ' + obj.data.id + '] ' + field + ' 字段更改为：' + value);
                    }

                }
            });
        });
        table.on('tool(manage)', function (obj) {
            switch (obj.event) {
                case 'detail':
                    //页面层
                    layer.open({
                        type: 2,
                        title: '编辑图片',
                        shadeClose: true,
                        shade: 0.8,
                        area: ['600px', '70%'],
                        content: '/flower/imagemanage?name=' + obj.data.name
                    });
                    break;
                case 'edit':
                    var index = layer.open({
                        type: 2,
                        title: '编辑类别',
                        shadeClose: true,
                        shade: 0.8,
                        area: ['600px', '70%'],
                        content: '/flower/edit?phylumname=' + obj.data.phylumname
                            + '&classname=' + obj.data.classname
                            + "&ordername=" + obj.data.ordername
                            + "&familyname=" + obj.data.familyname
                            + "&genusname=" + obj.data.genusname
                            + "&speciesname=" + obj.data.speciesname
                            + "&subspeciesname=" + obj.data.subspeciesname
                            + "&id=" + obj.data.id,
                        cancel: function (index, layero) {
                            table.reload('flowerData', {
                            });
                            layer.close(index)
                            return false;
                        }

                    });
                    break;
            };
        });
        var form = layui.form;
        var taxonomy = {};
        taxonomy.phylumname = $('#phylumname');
        taxonomy.classname = $('#classname');
        taxonomy.ordername = $('#ordername');
        taxonomy.familyname = $('#familyname');
        taxonomy.genusname = $('#genusname');
        taxonomy.speciesname = $('#speciesname');
        taxonomy.subspeciesname = $('#subspeciesname');

        var data = {};
        data.name = "";
        $.ajax({
            type: 'post',
            contentType: 'application/json',
            url: '/taxonomy/edit',
            data: JSON.stringify(data),
            success: function(data) {
                for( i = 0; i < data.length; i++ ) {
                    taxonomy.phylumname.append("<option value='" + data[i].name + "'>" + data[i].name + "</option>");
                }
                form.render();
            }
        });
        var phylumname, classname, ordername, familyname, genusname, speciesname, subspeciesname;
        form.on('select(phylumname)', function(data){
            phylumname = data.value;
            getTaxonomy(form, phylumname, taxonomy.phylumname, taxonomy.classname)
        });
        form.on('select(classname)', function(data){
            classname = data.value;
            getTaxonomy(form, classname, taxonomy.classname, taxonomy.ordername)
        });
        form.on('select(ordername)', function(data){
            ordername = data.value;
            getTaxonomy(form, ordername, taxonomy.ordername, taxonomy.familyname)
        });
        form.on('select(familyname)', function(data){
            familyname = data.value;
            getTaxonomy(form, familyname, taxonomy.familyname, taxonomy.genusname)
        });
        form.on('select(genusname)', function(data){
            genusname = data.value;
            getTaxonomy(form, genusname, taxonomy.genusname, taxonomy.speciesname)
        });
        form.on('select(speciesname)', function(data){
            speciesname = data.value;
            getTaxonomy(form, speciesname, taxonomy.speciesname, taxonomy.subspeciesname)
        });
        form.render();
        //监听提交
        form.on('submit(insertaction)', function(data){
            // layer.msg(JSON.stringify(data.field));
            var field = data.field
            $.ajax({
                type: 'post',
                contentType: 'application/json',
                url: '/flower/add',
                data: JSON.stringify(field),
                success: function(data) {
                    if (data.code == "200") {
                        layer.msg('添加成功');
                        table.reload('flowerData', {});
                        layer.closeAll();
                    }
                }
            });
            return false;
        });
        form.on('submit(searchaction)', function(data){
            var field = data.field
            table.reload('flowerData', {
                where: {
                    name: field.name,
                    latinname: field.latinname,
                    phylumname: field.phylumname,
                    classname: field.classname,
                    ordername: field.ordername,
                    familyname: field.familyname,
                    genusname: field.genusname
                }
            });
            return false;
        });

    });
</script>


</body>
</html>